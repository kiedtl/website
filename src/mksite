#!/bin/bash

template='<!DOCTYPE html><html lang=en><head><link href="data:image/png;base64," rel=icon type="image/png"><title>Kied Llaentenn</title><meta name=viewport content="width=device-width"><style>a{background:linear-gradient(to bottom,#cdcdcd,#cdcdcd) 50% calc(100% - 2px)/50% 2px no-repeat;color:#333;margin:-1px;text-decoration:none!important;-webkit-transition:all .35s ease-in-out;transition:all .35s ease-in-out}a:focus,a:hover{background-image:linear-gradient(to bottom,#777,#777);background-size:100% 3px;color:#111;-webkit-transition:all .35s ease-in-out!important;transition:all .35s ease-in-out!important}body{overflow-y:scroll;font-family:sans-serif}img,main{display:block;margin:25px auto}main{padding:20px;max-width:600px;line-height:1.6;word-wrap:break-word}img{max-width:100%}pre>code{display:block;padding:20px;white-space:pre-line}code{background:#eee;padding:2px}blockquote{border-left:7px solid #ddd;padding-left:14px;color:#666;margin:0}h1,h2,h3,h4{line-height:1.2}h1{font-family:monospace}</style></head><body><main>{{content}}</main></body></html>'

[[ -z $1 ]] &&
    rm -rf _site

mkdir -p _site/images

for md in _content/*.md; do
    file_name=${md##*/}

    [[ $file_name != index.md ]] &&
        home="<a href='/'>Home</a>"


    minify --type html \
        <<< "${template/'{{content}}'/${home}$(pandoc "$md")}" \
        > "_site/${file_name/%.md/.html}"

    home=
done

[[ $1 ]] &&
    exit

cd _site/images || exit

for img in ../../_images/*; do (
    file_name=${img##*/}
    convert "$img" -resize 1200x\>  "$file_name"    
    img2webp -lossy -q 90 "$file_name" -o "${file_name%.png}.webp"
) & done

cd ../..

for file in _static/*; do (
  printf "moving static file $file to _site/\n"
  cp "$file" _site/
) & done

wait
